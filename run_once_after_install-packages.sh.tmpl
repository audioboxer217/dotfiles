#!/usr/bin/env bash
{{ if eq .chezmoi.os "linux" -}}
tools_apt=(
            vim
            tmux
            ansible
            direnv
            fzf
            htop
            prettyping
            zsh
            zsh-syntax-highlighting
            rbenv
          )

sudo apt-get update && sudo apt-get install -y "${tools_apt[@]}"

### Manual Installations ###
# pyenv
curl https://pyenv.run | bash

# keybase
curl --remote-name https://prerelease.keybase.io/keybase_amd64.deb
sudo dpkg -i keybase_amd64.deb
sudo apt-get install -f
rm keybase_amd64.deb

# fx
fx_release=$(curl -s https://api.github.com/repos/antonmedv/fx/releases/latest | grep "browser_download_url.*linux_amd64" | cut -d : -f 2,3 | tr -d \")
sudo curl -fsLS $fx_release -o /usr/local/bin/fx
sudo chmod +x /usr/local/bin/fx

# Fira Nerd Font
fira_url=$(curl -s https://api.github.com/repos/ryanoasis/nerd-fonts/releases/latest | fx .assets '.map(x=> x.browser_download_url)' '.filter(x => x.includes("FiraCode"))[0]')
wget "${fira_url}" -O fira.zip
unzip fira.zip -d "${HOME}"/.fonts
fc-cache -fv
rm fira.zip

# bat
bat_url=$(curl -s https://api.github.com/repos/sharkdp/bat/releases/latest | fx .assets '.map(x=> x.browser_download_url)' '.filter(x => x.includes("amd64.deb"))' '.filter(x => !x.includes("musl"))[0]')
wget "${bat_url}" -O bat.deb
sudo dpkg -i bat.deb
rm bat.deb

# exa
exa_url=$(curl -s https://api.github.com/repos/ogham/exa/releases/latest | fx .assets '.map(x=> x.browser_download_url)' '.filter(x => x.includes("linux"))[0]')
wget "${exa_url}" -O exa.zip
unzip -p  exa.zip exa-linux-x86_64 > exa
sudo mv exa /usr/local/bin/exa
sudo chmod +x /usr/local/bin/exa
rm exa.zip
sudo curl -L https://raw.githubusercontent.com/ogham/exa/master/contrib/completions.bash -o /etc/bash_completion.d/exa

# z
sudo mkdir -p /usr/local/etc/profile.d
sudo curl "https://raw.githubusercontent.com/rupa/z/master/{z.sh}" -o /usr/local/etc/profile.d/"#1"

# tfenv
git clone https://github.com/kamatama41/tfenv.git "${HOME}"/.tfenv
sudo ln -sf "${HOME}"/.tfenv/bin/tfenv /usr/local/bin/tfenv
sudo ln -sf "${HOME}"/.tfenv/bin/terraform /usr/local/bin/terraform
{{ else if eq .chezmoi.os "darwin" -}}
# install homebrew if it's missing
if ! command -v brew >/dev/null 2>&1; then
  echo "Installing homebrew"
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

brew update && brew bundle install --global

#Enable completion and key-bindings for `fzf`
"$(brew --prefix)"/opt/fzf/install --all
{{ end -}}

# Install oh-my-zsh
if [ ! -d "${HOME}/.oh-my-zsh" ]; then
  wget https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O "${HOME}"/oh-my-zsh_install.sh
  chmod +x "${HOME}"/oh-my-zsh_install.sh
  "${HOME}"/oh-my-zsh_install.sh --unattended
fi

tfenv install latest

echo "Don't forget to:"
echo " - execute 'run_keybase'"
echo " - import gpg key (https://github.com/pstadler/keybase-gpg-github/blob/master/README.md)"